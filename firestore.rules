rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // NEW: Check subscription with expiry date
    function isSubscribed() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      // Admin always has access
      return request.auth != null && (
        userData.role == 'admin' ||
        (userData.subscriptionEnd != null && userData.subscriptionEnd > request.time) ||
        // Fallback for legacy users (temporary)
        (userData.isSubscribed == true && userData.subscriptionEnd == null)
      );
    }
    
    // Device limit check
    function checkDeviceLimit() {
       let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
       return isAdmin() || (userData.activeDevices == null) || (userData.activeDevices.size() <= 2);
    }

    // ========================================================================
    // USERS COLLECTION
    // ========================================================================
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Update: Only allow specific fields
      allow update: if request.auth != null 
                    && request.auth.uid == userId 
                    && (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'photoURL', 'activeDevices']));
      
      // Create: Strict field whitelist (no role, no isSubscribed, no subscriptionEnd)
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasOnly(['uid', 'email', 'displayName', 'photoURL', 'createdAt', 'activeDevices', 'role'])
                    && request.resource.data.uid == request.auth.uid
                    && (!('role' in request.resource.data) || request.resource.data.role == 'student');
    }

    // ========================================================================
    // LESSONS COLLECTION
    // ========================================================================
    match /lessons/{lessonId} {
      allow read: if isSubscribed() && checkDeviceLimit();
      allow write: if isAdmin();
    }
    
    // ========================================================================
    // PAYMENTS COLLECTION
    // ========================================================================
    match /payments/{paymentId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      allow update, delete: if isAdmin();
    }
    
    // ========================================================================
    // HAND RAISES
    // ========================================================================
    match /hand_raises/{raiseId} {
        allow read, write: if request.auth != null; 
    }

    // ========================================================================
    // CONFIG COLLECTION
    // ========================================================================
    match /config/{docId} {
        allow read: if true; 
        allow write: if isAdmin();
    }
    
    // ========================================================================
    // SYSTEM ERRORS (Write-only for auth users)
    // ========================================================================
    match /system_errors/{errorId} {
        allow create: if request.auth != null;
        allow read, update, delete: if isAdmin();
    }
    
    // ========================================================================
    // AUDIT LOGS (Admin read, Function write only)
    // ========================================================================
    match /audit_logs/{logId} {
        allow read: if isAdmin();
        allow create, update, delete: if false; // Only Cloud Functions can write
    }

    // ========================================================================
    // SECRET STREAM COLLECTION
    // ========================================================================
    match /secret_stream/{docId} {
        allow read: if isSubscribed();
        allow write: if isAdmin();
    }
  }
}
